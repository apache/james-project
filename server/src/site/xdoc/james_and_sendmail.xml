<?xml version="1.0"?>
<!--
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.    
-->
<document>

 <properties>
  <title>Sendmail integration</title>
  <author email="danny@apache.org">Danny Angus</author>
 </properties>

<body>

<section name="The problem">

  <p>
    This document explains how to configure sendmail to route all mail generated by /usr/sbin/sendmail or local mail on a host through James on the same host, including mail to local addresses without @host.<br/>
    All sendmail configuration file locations are for Redhat Linux 7.2, other installations may have different locations.<br/>
    <b>We take no responsibility for the quality of the information in this document. </b><br/><b>You should back-up any configuration files *before* you alter them.</b>
  </p>
</section>

<section name="Solution">
<subsection name="Step 1: Stop sendmail from running as an SMTP daemon">
<p>
Ok so you want to use James for everything, including delivering mail from localhost to local users.<br/>
Well the first step is to stop sendmail from starting up as the SMTP Daemon on port 25, otherwise it will route mail to itself and who knows what will happen then.<br/>
Open the sendmail configuration file <b>/etc/sysconfig/sendmail</b>
Change the line:<source>DAEMON=yes</source>into<source>DAEMON=no</source>
Restart sendmail with:<source>[root@apache root]# /etc/rc.d/init.d/sendmail restart</source>This will make sendmail process its outgoing queue, but not listen on port 25 for incoming mail.
</p>
</subsection>
<subsection name="Step 2: Set up sendmail to use relay">
<p>
Ok, so far so good, now you need to tell sendmail to relay everything, regardless of its rules, through James. James will take the roles of "local relay" (destination for all unqualified local addresses), "mail hub" (destination for all qualified local addresses) and "smart relay" (destination for all other mail) for this instance of sendmail, thereby catching everything.<br/>
So open <b>/etc/sendmail.cf</b> and..
<ul>
<li>Look for the line beginning <b>DS</b> make this line <b>DSesmtp:localhost</b></li>
<li>Look for the line beginning <b>DR</b> make this line <b>DResmtp:localhost</b></li>
<li>Look for the line beginning <b>DH</b> make this line <b>DHesmtp:localhost</b></li>
</ul>
Now that wasn't too hard was it?<br/>
What we have done is to tell sendmail to use its "mailer" called <b>esmtp</b> to relay mail using ESMTP to localhost for each role.<br/>
Of course no-one in their right mind would relay mail to localhost, because it would loop forever right?
</p>
</subsection>

<subsection name="Step 3: Stop sendmail complaining about mail apparently looping back">
<p>
The developers of sendmail have, wisely, built sendmail in such a way as to prevent, by default, mail being sent by sendmail back to itself, this is done by making a quick check on outgoing mail to see if its destination is our machine. If it is you'll see this message <b><i>config error: mail loops back to me</i></b> when you try to send mail.<br/>
But we *want* to relay mail to localhost, and because sendmail isn't receiving our mail, James is, we won't be creating a loop. (make sure you've followed step one though).<br/>
So open <b>/etc/sendmail.cf</b> again and go to the bottom of the file, start scrolling upwards until you see the declaration of the esmtp mailer it'll look something like this
<source>
Mesmtp,     P=[IPC], F=mDFMuXa, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
        T=DNS/RFC822/SMTP,
        A=TCP $h
</source>
You need to change it so its more like this:  :-D
<source>
Mesmtp,     P=[IPC], F=kmDFMuXa, S=EnvFromSMTP/HdrFromSMTP, R=EnvToSMTP, E=\r\n, L=990,
        T=DNS/RFC822/SMTP,
        A=TCP $h
</source>
But seriously, we've added a <b>k</b> to the "F=" list <b>F=mDFMuXa</b> becomes <b>F=kmDFMuXa</b><br/>
And again, thats it, sendmail will now skip the loopback test on mail leaving through the esmtp mailer.
</p>
<p>Now you have to make some tests.<br/>Try each of the following, replace names in [] with names of the kind described.
<source>/[root@apache root]# mail -v [real-localusername]

[root@apache root]# mail -v [nonexistant-localusername]

[root@apache root]# mail -v [real-localusername]@localhost

[root@apache root]# mail -v [real-localusername]@[myhostname.mydomainname]

[root@apache root]# mail -v [real-username]@[real-remote-account]
</source>
Sendmail echoes each conversation to STDOUT so you can see what its trying to do with each mail.<br/>
</p>
</subsection>

<subsection name="Step 4: If that wasn't enough James requires SMTP AUTH">
<p>
SMTP AUTH is a different Kettle of Fish.<br/>
The scenario is that you're using SMTP AUTH on James to restrict SMTP relaying to authenticated users, allowing them to connect from any IP address but still not letting James become an open relay for spam, cool.<br/>
However you now want to let sendmail relay through James, so you need to tell it how to authenticate.<br/>
So open <b>/etc/sendmail.cf</b> <i>again</i> and this time..
<ul>
<li>Look for the line beginning <b>O AuthMechanisms=</b> If this line is commented out with a leading <b>#</b>, remove the <b>#</b> then make sure LOGIN and PLAIN are at the beginning of this line like this <b>O AuthMechanisms=LOGIN PLAIN GSSAPI KERBEROS_V4 DIGEST-MD5 CRAM-MD5</b></li>
<li>Look for the line beginning <b>O DefaultAuthInfo=</b> If this line is commented out with a leading <b>#</b>, remove the <b>#</b> then make this line <b>O DefaultAuthInfo=/etc/mail/default-auth-info</b></li>
<li>Create a user account on James for sendmail to login as.</li>
<li>Create the file <b>/etc/mail/default-auth-info</b></li>
<li>It should contain this<source>username
username
password
localhost</source>Yes the username appears twice.</li>
<li>Replace username and password with the details of the account you just created.</li>
<li>This file has to be chmod'ed 600 (-rw------) or sendmail won't read it.</li>
<li>Look for the line beginning <b>O AuthOptions=</b> If this line is commented out with a leading <b>#</b>, remove the <b>#</b> and it should be <b>O AuthOptions=A</b></li>
</ul>

<h1><i><b>Ta-da!</b></i></h1> Now you're ready to run the tests in Step3, all of the mail should be accepted, the most likely rejection will be the final one.
</p>
</subsection>
<p>Thats it, good luck and happy mailing :)<br/>Danny Angus</p>
</section>

</body>
</document>
